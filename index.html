<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Pink Sanctuary: Vision Board</title>
    <!-- ØªØ­Ù…ÙŠÙ„ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø· Ù†Ø§Ø¹Ù… ÙˆÙ…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø«ÙŠÙ… Ø§Ù„Ø¨Ù†Ø§Ù†ÙŠ -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        /* Ø§Ù„ØªØ®ØµÙŠØµ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø«ÙŠÙ… ÙˆØ§Ù„Ø®Ø· */
        :root {
            /* Ø¯Ø±Ø¬Ø§Øª ÙˆØ±Ø¯ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø³ØªÙˆØ­Ø§Ø© Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©: Ø£ÙƒØ«Ø± Ù†Ø¹ÙˆÙ…Ø© ÙˆØ¯ÙØ¦Ø§Ù‹ */
            --pink-light: #FFF0F5; /* Ø®Ù„ÙÙŠØ© Ù†Ø§Ø¹Ù…Ø© Ø¬Ø¯Ø§Ù‹ (Blush Pink) */
            --pink-medium: #FFB6C1; /* ÙˆØ±Ø¯ÙŠ Ù…ØªÙˆØ³Ø· Ø¯Ø§ÙØ¦ (Light Pink) */
            --pink-dark: #FF69B4; /* ÙˆØ±Ø¯ÙŠ ØºØ§Ù…Ù‚ Ù„Ù„Ø¨Ø±ÙˆØ² (Deep Pink) */
            --pink-accent: #FF1493; /* ÙˆØ±Ø¯ÙŠ Ù„Ø§Ù…Ø¹ Ù„Ù„Ù€ FAB ÙˆØ§Ù„ØªØ±ÙƒÙŠØ² (Deep Magenta) */
            --text-color: #383838; /* Ù„ÙˆÙ† Ù†Øµ Ø´Ø¨Ù‡ Ø£Ø³ÙˆØ¯ Ù†Ø§Ø¹Ù… */
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--pink-light);
            color: var(--text-color);
        }
        .tab-bar {
            /* Ø¥Ø¶Ø§Ø¡Ø© ÙˆØ±Ø¯ÙŠØ© Ø®ÙÙŠÙØ© Ø¹Ù„Ù‰ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
            box-shadow: 0 -8px 20px -5px rgba(255, 105, 180, 0.3);
        }
        .floating-action-button {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .floating-action-button:active {
            transform: scale(0.95) rotate(45deg); /* Ø¯ÙˆØ±Ø§Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
            box-shadow: 0 0 0 0.2rem rgba(255, 20, 147, 0.5);
        }
        .fab-icon-plus {
            transition: transform 0.3s ease;
            transform: rotate(0deg);
        }
        .fab-icon-close {
            transition: transform 0.3s ease;
            transform: rotate(45deg);
        }
        /* ØªÙˆÙ‡Ø¬ ÙˆØ±Ø¯ÙŠ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØ¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¨Ø±Ø§Ø² */
        .pink-glow-shadow {
            box-shadow: 0 0 15px rgba(255, 105, 180, 0.7);
        }
        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© */
        .quick-action-menu {
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .quick-action-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        .quick-action-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
        .quick-action-leave {
            opacity: 1;
            transform: translateY(0);
        }
        .quick-action-leave-active {
            opacity: 0;
            transform: translateY(10px);
        }
        .modal-enter { opacity: 0; transform: scale(0.9); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s ease, transform 0.2s ease; }
        .modal-leave-active { opacity: 0; transform: scale(0.9); transition: opacity 0.2s ease, transform 0.2s ease; }
        .vision-board {
            min-height: calc(100vh - 150px);
            background-color: #ffffff; /* Ù„ÙˆØ­ Ø£Ø¨ÙŠØ¶ Ù„Ù„Ø¥Ø¨Ø¯Ø§Ø¹ */
            border-radius: 1.5rem;
            padding: 1rem;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1); /* Ø¸Ù„ Ø®ÙÙŠÙ Ù„Ù„ÙˆØ­Ø© */
        }
        .vision-item {
            cursor: grab;
            transition: all 0.2s;
            position: absolute;
            box-shadow: 0 4px 10px -1px rgba(0, 0, 0, 0.15); /* Ø¸Ù„ Ø£ÙƒØ¨Ø± ÙˆØ£Ø¹Ù…Ù‚ */
            border: 2px solid var(--pink-medium);
            background-color: #FFFFFF; /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ù„Ù„Ø¹Ù†Ø§ØµØ± */
        }
        .vision-item:active {
            cursor: grabbing;
            z-index: 50;
            transform: scale(1.05);
        }
        /* Breathing Display Custom Styling */
        #breathing-display {
            transition-property: transform, background-color, box-shadow; 
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); /* Ø­Ø±ÙƒØ© Ø§Ù„ØªÙ†ÙØ³ Ø£ÙƒØ«Ø± Ø³Ù„Ø§Ø³Ø© (ease-in-out) */
            transition-duration: 4000ms;
        }
        /* Custom class for list items in grounding */
        .grounding-list-item {
            background-color: #ffe6f0; /* Ù„ÙˆÙ† ÙˆØ±Ø¯ÙŠ Ù†Ø§Ø¹Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
            border-radius: 1.25rem; /* Ø²ÙˆØ§ÙŠØ§ Ø£ÙƒØ«Ø± Ø¯Ø§Ø¦Ø±ÙŠØ© */
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙˆØ±Ø¯ÙŠØ© */
        .pink-button {
             box-shadow: 0 4px 10px rgba(255, 20, 147, 0.3); /* Ø¸Ù„ ÙˆØ±Ø¯ÙŠ Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
        }
        .modal-content-styled {
             /* Ø¥Ø¶Ø§ÙØ© Ø¥Ø·Ø§Ø± ÙˆØ±Ø¯ÙŠ Ø¬Ù…ÙŠÙ„ Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
            border: 4px solid var(--pink-dark);
            box-shadow: 0 10px 20px rgba(255, 105, 180, 0.5); /* ØªÙˆÙ‡Ø¬ Ø­ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased">

    <!-- Header -->
    <header class="p-4 shadow-md sticky top-0 z-40 rounded-b-xl" style="background-color: var(--pink-medium);">
        <h1 class="text-center text-3xl font-extrabold text-white tracking-wider text-shadow-lg">
            My Pink Sanctuary ğŸ€
        </h1>
        <p class="text-center text-sm text-white/90 font-medium mt-1">
            Ø¯ÙØªØ±Ùƒ Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø¯Ø§ÙØ¦ ÙˆØ§Ù„Ø¢Ù…Ù†
        </p>
    </header>

    <!-- Main Content Area (Dynamic) -->
    <main id="app-container" class="flex-grow p-4 overflow-y-auto">
        <!-- Content will be rendered here -->
    </main>
    
    <!-- Quick Action Menu -->
    <div id="quick-action-menu" class="quick-action-menu fixed bottom-20 left-1/2 transform -translate-x-1/2 mb-4 z-50 flex flex-col items-center space-y-4 hidden">
        <button id="action-add-image" class="action-item p-4 rounded-full text-white shadow-lg text-2xl transition duration-200 hover:scale-110 pink-button" style="background-color: var(--pink-dark);" title="Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù/ØµÙˆØ±Ø©">
            ğŸ–¼ï¸
        </button>
        <button id="action-add-text" class="action-item p-4 rounded-full text-white shadow-lg text-2xl transition duration-200 hover:scale-110 pink-button" style="background-color: var(--pink-dark);" title="Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø®Ù„ Ù†ØµÙŠ">
            ğŸ“
        </button>
        <button id="action-add-reminder" class="action-item p-4 rounded-full text-white shadow-lg text-2xl transition duration-200 hover:scale-110 pink-button" style="background-color: var(--pink-dark);" title="Ø¥Ø¶Ø§ÙØ© ØªØ°ÙƒÙŠØ±">
            ğŸ””
        </button>
    </div>

    <!-- Floating Action Button (FAB) - Now for toggling the menu -->
    <button id="fab-button" class="floating-action-button fixed z-50 bottom-4 left-1/2 transform -translate-x-1/2 p-5 rounded-full text-white shadow-xl text-3xl transition duration-300 ease-in-out hover:scale-105"
            style="background-color: var(--pink-accent); box-shadow: 0 10px 20px -3px rgba(255, 20, 147, 0.5);">
        <span id="fab-icon" class="fab-icon-plus font-light">+</span>
    </button>

    <!-- Navigation Bar (Tab Bar) -->
    <nav class="tab-bar bg-white sticky bottom-0 z-40 p-3 rounded-t-3xl">
        <div class="flex justify-around items-center">
            <!-- Vision Board Tab -->
            <button id="tab-vision" data-page="vision" class="tab-item flex flex-col items-center p-2 rounded-xl transition duration-200 text-gray-400 hover:text-gray-700">
                <span class="text-2xl">âœ¨</span>
                <span class="text-xs font-medium mt-1">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</span>
            </button>
            <!-- Reminders Tab -->
            <button id="tab-reminders" data-page="reminders" class="tab-item flex flex-col items-center p-2 rounded-xl transition duration-200 text-gray-400 hover:text-gray-700">
                <span class="text-2xl">ğŸ””</span>
                <span class="text-xs font-medium mt-1">ØªØ°ÙƒÙŠØ±Ø§Øª</span>
            </button>
            <!-- My Journal Tab -->
            <button id="tab-journal" data-page="journal" class="tab-item flex flex-col items-center p-2 rounded-xl transition duration-200 text-gray-400 hover:text-gray-700">
                <span class="text-2xl">ğŸ’–</span>
                <span class="text-xs font-medium mt-1">Ù…Ø°ÙƒØ±Ø§ØªÙŠ</span>
            </button>
            <!-- Anti-Overthinking Tab -->
            <button id="tab-anti" data-page="anti" class="tab-item flex flex-col items-center p-2 rounded-xl transition duration-200 text-gray-400 hover:text-gray-700">
                <span class="text-2xl">ğŸ§˜â€â™€ï¸</span>
                <span class="text-xs font-medium mt-1">Ù‡Ø¯ÙˆØ¡</span>
            </button>
        </div>
    </nav>

    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-30 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div id="modal-content" class="bg-white p-6 rounded-3xl w-11/12 max-w-md shadow-2xl modal-content-styled modal-enter">
            <!-- Modal content will be inserted here -->
        </div>
    </div>

    <!-- Error/Status Message Container -->
    <div id="message-box" class="fixed top-0 left-0 right-0 p-4 text-center text-white font-bold transition-transform duration-300 ease-in-out transform -translate-y-full z-[60] shadow-lg"
         style="background-color: var(--pink-accent);">
        <!-- Status messages appear here -->
    </div>
    
    <!-- PWA Manifest for Add to Home Screen -->
    <link rel="manifest" href="data:application/json;base64,eyJpY29ucyI6IFt7InNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby8xOTJ4MTkyL0ZGNTVGMC9mZmY/dGV4dD0lRTIlOUQlQTglMjZmb250PXdpZGVoZWFkZXIiLCJzaXplcyI6ICIxOTJ4MTkyIiwidHlwZSI6ICJpbWFnZS9wbmciIH0sIHsic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvRkY1NUYwL2ZmZj90ZXh0PSVFRiU5RCVBRSUyNmZvbnQ9d2lkZWhlYWRlciIsInNpemVzIjogIjUxMng1MTIiLCJ0eXBlIjogImltYWdlL3BuZyIgfV0sICJuYW1lIjogIk15IFBpbmssIFNhbmN0dWFyeSIsICJzaG9ydF9uYW1lIjogIlNhbmN0dWFyeSIsICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLCAic3RhcnRfdXJsIjogIi8iLCAiYmFja2dyb3VuZF9jb2xvciI6ICIjRkNFN0Y2IiwgInRoZW1lX2NvbG9yIjogIiNGRDVFOUMiLCAicGhvbmUiOiB0cnVlIH0=">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/FF1493/fff?text=%F0%9F%92%96">
    <!-- End PWA Manifest -->


    <!-- Firebase SDKs -->
    <script type="module">
        // Import all necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase Configuration (YOUR KEYS ARE HERE)
        const firebaseConfig = {
             // â¬‡ï¸ Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„Ø®Ø§ØµØ© ØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ Ù‡Ù†Ø§ â¬‡ï¸
             apiKey: "AIzaSyAvCyIkI72PRYAbYwh0RJPxb5QT2c7aZVM", 
             authDomain: "mental-health-app-3d219.firebaseapp.com", 
             projectId: "mental-health-app-3d219", 
             storageBucket: "mental-health-app-3d219.firebasestorage.app",
             messagingSenderId: "620112651239",
             appId: "1:620112651239:web:180b2a6d91fb2ea69ed342"
             // â¬†ï¸ ØªØ£ÙƒØ¯ÙŠ Ø£Ù† Ù‡Ø°Ù‡ Ù‡ÙŠ Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„ØµØ­ÙŠØ­Ø© â¬†ï¸
        };

        // Global variables and initialization
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId; // Use project ID as default app ID
        let db, auth;
        let userId = null;
        let isAuthReady = false;
        let dbListeners = [];
        let currentPage = 'vision'; // Default page is Vision Board
        let isActionMenuOpen = false; // New state for quick action menu

        // Data holders
        let visionItems = [];
        let reminders = [];
        let journalEntries = [];
        
        // --- Anti-Overthinking Specific States ---
        let breathingInterval = null; // Ù„ØªÙ†ÙÙŠØ° Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙ†ÙØ³ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        let countdownInterval = null; // Ù„Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
        let isBreathingActive = false;
        let currentStepIndex = 0; // ØªØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        let breathingSteps = [];
        
        const mentalHealthQuotes = [
            { quote: "ØªØ°ÙƒØ±ÙŠØŒ Ø­ØªÙ‰ Ø£ØµØ¹Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø³ØªÙ†ØªÙ‡ÙŠ. Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø© Ø£ÙŠØ¶Ø§Ù‹ Ø³ØªÙ…Ø¶ÙŠ.", source: "ØªØ°ÙƒÙŠØ± Ø°Ø§ØªÙŠ" },
            { quote: "Ø£Ù†ØªÙ Ø£Ù‚ÙˆÙ‰ Ù…Ù…Ø§ ØªØ¸Ù†ÙŠÙ†ØŒ ÙˆÙƒÙ„ Ù…Ø§ Ø¹Ù„ÙŠÙƒÙ ÙØ¹Ù„Ù‡ Ù‡Ùˆ Ø£Ù† ØªØªÙ†ÙØ³ÙŠ.", source: "ØªØ£ÙƒÙŠØ¯" },
            { quote: "Ø§Ù„ØµØ­Ø© Ø§Ù„Ù†ÙØ³ÙŠØ© Ù„ÙŠØ³Øª ÙˆØ¬Ù‡Ø©ØŒ Ø¨Ù„ Ù‡ÙŠ Ø±Ø­Ù„Ø© Ù…Ø³ØªÙ…Ø±Ø© Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ÙŠØ©.", source: "ØªÙˆØ¹ÙŠØ©" },
            { quote: "Ø§Ø³Ø­Ø¨ÙŠ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ø§Ù„Ø¢Ù†. Ø£Ù†ØªÙ ÙÙŠ Ø£Ù…Ø§Ù†. ÙƒÙ„ Ø´ÙŠØ¡ Ø³ÙŠØ³ÙŠØ± Ø¹Ù„Ù‰ Ù…Ø§ ÙŠØ±Ø§Ù….", source: "Ø±Ø³Ø§Ù„Ø© Ù‡Ø§Ø¯Ø¦Ø©" },
            { quote: "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø£ÙÙƒØ§Ø± Ù„Ø§ ÙŠØ¹Ù†ÙŠ Ø§Ù„ÙØ´Ù„ØŒ Ø¨Ù„ ÙŠØ¹Ù†ÙŠ Ø£Ù†ÙƒÙ ØªØ®ØªØ§Ø±ÙŠÙ† Ø§Ù„Ø³Ù„Ø§Ù….", source: "ØªØ°ÙƒÙŠØ±" },
            { quote: "Ø§Ù„Ø¹Ù†Ø§ÙŠØ© Ø¨Ù†ÙØ³Ùƒ Ù‡ÙŠ Ø¥Ù†ØªØ§Ø¬ÙŠØ©. Ø§Ù„Ø±Ø§Ø­Ø© Ù„ÙŠØ³Øª Ø±ÙØ§Ù‡ÙŠØ© Ø¨Ù„ Ø¶Ø±ÙˆØ±Ø©.", source: "ØªÙˆØ¹ÙŠØ©" },
            { quote: "Ø§ØºÙØ±ÙŠ Ù„Ù†ÙØ³ÙƒÙ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡. Ø£Ù†ØªÙ Ø¥Ù†Ø³Ø§Ù†Ø©ØŒ ÙˆÙ‡Ø°Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù†Ù…Ùˆ.", source: "ØªØ£ÙƒÙŠØ¯" },
            { quote: "Ù„Ø§ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ†ÙŠ Ù…Ø«Ø§Ù„ÙŠØ© Ù„ØªÙƒÙˆÙ†ÙŠ Ù…Ø­Ø¨ÙˆØ¨Ø©. Ø£Ù†ØªÙ ÙƒØ§ÙÙŠØ©.", source: "ØªÙˆÙƒÙŠØ¯" },
            { quote: "Ù…Ù‡Ù…Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¹Ø§ØµÙØ© Ø´Ø¯ÙŠØ¯Ø©ØŒ ØªØ°ÙƒØ±ÙŠ Ø£Ù†ÙƒÙ Ø³ÙÙŠÙ†Ø© Ù‚ÙˆÙŠØ©.", source: "ØªÙˆØ¹ÙŠØ©" },
        ];


        // --- Utility Functions (UI Helpers) ---
        
        function showMessage(message, type = 'success') {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.style.backgroundColor = type === 'success' ? 'var(--pink-accent)' : '#EF4444';
            msgBox.style.transform = 'translateY(0)';
            setTimeout(() => {
                msgBox.style.transform = 'translateY(-100%)';
            }, 3000);
        }

        function openModal(htmlContent) {
            // Close quick action menu first if open
            if (isActionMenuOpen) {
                toggleActionMenu(false);
            }
            
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = htmlContent;
            modalContainer.classList.remove('hidden');
            modalContent.classList.remove('modal-leave-active');
            modalContent.classList.add('modal-enter-active');
            modalContent.classList.add('modal-content-styled'); // Apply the pink border/glow
        }

        function closeModal() {
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            
            modalContent.classList.remove('modal-enter-active');
            modalContent.classList.add('modal-leave-active');

            setTimeout(() => {
                modalContainer.classList.add('hidden');
                modalContent.innerHTML = '';
                modalContent.classList.remove('modal-content-styled');
            }, 200); 
        }

        // --- Firebase Core Setup ---
        
        function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Auth State Listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        // Start listening to data once authenticated
                        startDatabaseListeners();
                        renderPage(currentPage);
                        showMessage(`ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ù‡ÙˆÙŠØªÙƒ (${userId.substring(0, 8)}...) Ø¬Ø§Ù‡Ø²Ø©.`);
                    } else {
                        // Sign in anonymously if no user is found
                        await signInAnonymously(auth);
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                const errorMsg = `Initialization error: ${error.code || error.message}. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…ÙØ§ØªÙŠØ­ Firebase ÙˆÙ‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù† (Rules).`;
                document.getElementById('app-container').innerHTML = `<div class="p-6 text-center text-red-600 bg-red-100 rounded-2xl shadow-lg mt-8">${errorMsg}</div>`;
            }
        }

        // --- Database Path Helpers ---

        function getCollectionPath(collectionName) {
            if (!userId) {
                console.error("Cannot get collection path: User ID is null.");
                return null;
            }
            // Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø®Ø§Øµ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…: artifacts/{appId}/users/{userId}/{collectionName}
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        }
        
        function getCollectionRef(collectionName) {
            const path = getCollectionPath(collectionName);
            // âš ï¸ ØªØ£ÙƒØ¯Ù†Ø§ Ø£Ù† path Ù„ÙŠØ³ null Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±Ø¬Ø¹ 
            return path && db ? collection(db, path) : null;
        }

        // --- Data Listeners & Handlers ---

        function stopDatabaseListeners() {
            dbListeners.forEach(unsubscribe => unsubscribe());
            dbListeners = [];
        }

        function startDatabaseListeners() {
            if (!isAuthReady || !db) return;
            
            stopDatabaseListeners();

            // 1. Vision Board Listener
            const visionRef = getCollectionRef('visionItems');
            if (visionRef) {
                const q = query(visionRef);
                const unsub = onSnapshot(q, (snapshot) => {
                    visionItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentPage === 'vision') renderPage('vision'); // Re-render Vision Board on change
                }, error => console.error("Error fetching vision items:", error));
                dbListeners.push(unsub);
            }
            
            // 2. Reminders Listener
            const remindersRef = getCollectionRef('reminders');
            if (remindersRef) {
                // Order reminders by the scheduled time
                const q = query(remindersRef, orderBy('timestamp', 'desc'));
                const unsub = onSnapshot(q, (snapshot) => {
                    reminders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (currentPage === 'reminders') renderPage('reminders'); // Re-render Reminders on change
                }, error => console.error("Error fetching reminders:", error));
                dbListeners.push(unsub);
            }
            
            // 3. Journal Listener
            const journalRef = getCollectionRef('journal');
            if (journalRef) {
                // Order journal entries by creation date
                const q = query(journalRef, orderBy('createdAt', 'desc'));
                const unsub = onSnapshot(q, (snapshot) => {
                    journalEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if(currentPage === 'journal') renderPage('journal'); // Only render if on the page
                }, error => console.error("Error fetching journal entries:", error));
                dbListeners.push(unsub);
            }
        }

        // --- Core Application Logic (CRUD) ---

        // Image Utility: Converts File object to Base64 String
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // --- Vision Board Logic (Image/Goal) ---

        async function handleAddVisionItem(imageFile, title, description) {
            if (!isAuthReady || !imageFile) return showMessage("Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØµÙˆØ±Ø©.", 'error');

            try {
                // 1. Convert image to Base64 for Firestore (simple storage solution)
                const base64Image = await fileToBase64(imageFile);
                
                // 2. Create the document data
                const newItem = {
                    title: title || 'Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯',
                    description: description || '',
                    imageUrl: base64Image,
                    createdAt: Date.now(),
                    // Default position (top left corner)
                    x: 20, 
                    y: 20,
                    width: 150,
                    height: 150,
                };
                
                const visionRef = getCollectionRef('visionItems');
                if (!visionRef) {
                    throw new Error("Vision collection reference is null.");
                }

                // 3. Save to Firestore
                await addDoc(visionRef, newItem);
                closeModal();
                showMessage("âœ¨ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ù Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ† Ø³Ø­Ø¨Ù‡.");
            } catch (e) {
                console.error("Error adding vision item:", e);
                showMessage("âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù‡Ø¯Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†!", 'error');
            }
        }
        
        async function updateVisionItemPosition(id, x, y) {
            if (!isAuthReady) return;
            const docRef = doc(getCollectionRef('visionItems'), id);
            try {
                await updateDoc(docRef, { x, y, lastMoved: Date.now() });
            } catch (e) {
                console.error("Error updating position:", e);
            }
        }

        // --- Reminders Logic (Text/Time) ---
        
        async function handleAddReminder(text, scheduleTime) {
            if (!isAuthReady || !text.trim()) return showMessage("Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªØ°ÙƒÙŠØ±.", 'error');

            try {
                const newReminder = {
                    text: text,
                    schedule: scheduleTime,
                    timestamp: Date.now(),
                    sent: false
                };
                
                const remindersRef = getCollectionRef('reminders');
                if (!remindersRef) {
                    throw new Error("Reminders collection reference is null.");
                }

                await addDoc(remindersRef, newReminder); 
                
                closeModal();
                showMessage("ğŸ”” ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.");
                // Schedule local notification (requires browser permission)
                scheduleLocalNotification(text, scheduleTime);
            } catch (e) {
                console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ°ÙƒÙŠØ±. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø®Ø·Ø£ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø£Ù…Ø§Ù† Firebase (Security Rules) Ø£Ùˆ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„:", e);
                showMessage("âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ°ÙƒÙŠØ±. (Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù€ Console Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„)", 'error');
            }
        }
        
        async function handleDeleteReminder(id) {
            if (!isAuthReady) return;
            const docRef = doc(getCollectionRef('reminders'), id);
            try {
                await deleteDoc(docRef);
                showMessage("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ°ÙƒÙŠØ±.");
            } catch (e) {
                console.error("Error deleting reminder:", e);
                showMessage("âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªØ°ÙƒÙŠØ±.", 'error');
            }
        }
        
        // --- Journal Logic (Text) ---

        async function handleSaveJournalEntry(text) {
             if (!isAuthReady || !text.trim()) return showMessage("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø¥Ø¯Ø®Ø§Ù„ ÙØ§Ø±Øº.", 'error');

             try {
                 const journalRef = getCollectionRef('journal');
                 if (!journalRef) {
                    throw new Error("Journal collection reference is null.");
                 }
                 
                 await addDoc(journalRef, {
                     content: text,
                     createdAt: Date.now()
                 });
                 closeModal();
                 // Re-render journal page if user is on it
                 if(currentPage === 'journal') renderPage('journal');
                 showMessage("ğŸ’– ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø®Ù„ Ø¨Ù†Ø¬Ø§Ø­.");
             } catch (e) {
                 console.error("Error saving journal entry:", e);
                 showMessage("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚ÙˆØ§Ø¹Ø¯ Firebase.", 'error');
             }
        }

        // --- Notification API (Client Side) ---
        
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                showMessage("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.", 'error');
            } else if (Notification.permission === "default") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        showMessage("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª!");
                    } else {
                        showMessage("âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.", 'error');
                    }
                });
            } else if (Notification.permission === "granted") {
                // Do nothing, already granted
            }
        }

        function scheduleLocalNotification(text, scheduleTime) {
            if (Notification.permission !== "granted") {
                 requestNotificationPermission(); // Ask again if needed
                 return;
            }
            
            const targetTime = new Date(scheduleTime).getTime();
            const delay = targetTime - Date.now();

            if (delay > 0) {
                // In a real PWA/App, we'd use Service Worker for persistent notifications
                // Here, we use a simple JS timeout (only works while app is open)
                setTimeout(() => {
                    new Notification("ØªØ°ÙƒÙŠØ± Ù…Ù† My Sanctuary ğŸ””", {
                        body: text,
                        icon: 'https://placehold.co/192x192/FF1493/fff?text=%F0%9F%92%96',
                    });
                }, delay);
            }
        }


        // --- UI Rendering ---

        function renderPage(pageName) {
            currentPage = pageName;
            const container = document.getElementById('app-container');
            const tabItems = document.querySelectorAll('.tab-item');
            
            // Close the quick action menu when switching pages
            toggleActionMenu(false); 
            
            // Stop breathing exercise if switching away from the anti page
            if (pageName !== 'anti' && isBreathingActive) {
                toggleBreathingExercise(true); // Stop forcefully
            }

            // Reset UI states
            container.innerHTML = '';
            tabItems.forEach(item => {
                if (item.dataset.page === pageName) {
                    item.style.color = 'var(--pink-accent)';
                    item.classList.add('pink-glow-shadow');
                } else {
                    item.style.color = '#9CA3AF'; // gray-400
                    item.classList.remove('pink-glow-shadow');
                }
            });

            // Render content based on page
            switch (pageName) {
                case 'vision':
                    renderVisionBoard(container);
                    break;
                case 'reminders':
                    renderReminders(container);
                    break;
                case 'journal':
                    renderJournal(container);
                    break;
                case 'anti':
                    renderAntiOverthinking(container);
                    break;
            }
        }
        
        // --- FAB/Quick Action Logic ---
        
        function toggleActionMenu(force) {
            const menu = document.getElementById('quick-action-menu');
            const icon = document.getElementById('fab-icon');
            
            // Determine the new state
            isActionMenuOpen = typeof force === 'boolean' ? force : !isActionMenuOpen;

            if (isActionMenuOpen) {
                menu.classList.remove('hidden', 'quick-action-leave-active');
                menu.classList.add('quick-action-enter-active');
                icon.classList.remove('fab-icon-plus');
                icon.classList.add('fab-icon-close');
                icon.textContent = 'âœ•';
            } else {
                 menu.classList.remove('quick-action-enter-active');
                 menu.classList.add('quick-action-leave-active');
                 icon.classList.remove('fab-icon-close');
                 icon.classList.add('fab-icon-plus');
                 icon.textContent = '+';
                 setTimeout(() => {
                    menu.classList.add('hidden');
                 }, 200); // Wait for transition
            }
        }


        // --- Vision Board UI & Modal ---

        function renderVisionBoard(container) {
            const visionHTML = `
                <h2 class="text-xl font-bold mb-4 text-gray-700 text-center">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (Vision Board) âœ¨</h2>
                <div id="vision-board-area" class="vision-board relative mx-auto overflow-hidden">
                    ${visionItems.map(item => renderVisionItem(item)).join('')}
                    ${visionItems.length === 0 ? '<p class="text-center text-gray-400 p-8">Ø§Ø¶ØºØ·ÙŠ Ø¹Ù„Ù‰ Ø²Ø± (+) ÙˆØ§Ø®ØªØ±ØªÙŠ ğŸ–¼ï¸ Ù„Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ù‡Ø¯Ù!</p>' : ''}
                </div>
            `;
            container.innerHTML = visionHTML;
            
            // Attach drag event listeners after rendering
            visionItems.forEach(item => {
                const element = document.getElementById(`vision-item-${item.id}`);
                if (element) {
                    attachDragListeners(element, item.id);
                }
            });
        }
        
        function renderVisionItem(item) {
            // Using a slightly smaller height for better mobile layout
            const itemHeight = item.height > 100 ? item.height : 150; 
            const imgHeight = itemHeight - 30;

            return `
                <div id="vision-item-${item.id}" class="vision-item p-2 rounded-xl w-[${item.width}px] shadow-lg" 
                     style="left: ${item.x}px; top: ${item.y}px; height: ${itemHeight}px; width: 150px;">
                    <img src="${item.imageUrl}" alt="${item.title}" class="w-full h-[${imgHeight}px] object-cover rounded-lg mb-1" loading="lazy" 
                         onerror="this.onerror=null;this.src='https://placehold.co/150x120/${getComputedStyle(document.documentElement).getPropertyValue('--pink-medium').trim().slice(1)}/fff?text=ØµÙˆØ±Ø©+Ù…ÙÙ‚ÙˆØ¯Ø©';">
                    <p class="text-sm font-semibold text-center text-gray-700 truncate">${item.title}</p>
                    <p class="text-xs text-center text-gray-500 truncate">${item.description}</p>
                </div>
            `;
        }
        
        function attachDragListeners(element, id) {
            let active = false;
            let currentX, currentY, initialX, initialY;
            const container = document.getElementById('vision-board-area');

            const dragStart = (e) => {
                e.preventDefault();
                // Ensure to get clientX/Y from the first touch point if it's a touch event
                initialX = e.clientX || e.touches[0].clientX;
                initialY = e.clientY || e.touches[0].clientY;
                element.style.zIndex = 50; 
                active = true;
            };

            const dragEnd = () => {
                if (!active) return;
                active = false;
                element.style.zIndex = 10;
                
                // Get final position relative to the container
                const finalX = element.offsetLeft;
                const finalY = element.offsetTop;
                
                // Update position in Firebase
                updateVisionItemPosition(id, finalX, finalY);
            };

            const drag = (e) => {
                if (!active) return;
                
                // Ensure to get clientX/Y from the first touch point if it's a touch event
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.touches[0].clientY;

                currentX = clientX - initialX;
                currentY = clientY - initialY;
                
                initialX = clientX;
                initialY = clientY;
                
                let newX = element.offsetLeft + currentX;
                let newY = element.offsetTop + currentY;
                
                // Boundary checking
                newX = Math.max(0, Math.min(newX, container.offsetWidth - element.offsetWidth));
                newY = Math.max(0, Math.min(newY, container.offsetHeight - element.offsetHeight));

                element.style.left = `${newX}px`;
                element.style.top = `${newY}px`;
            };

            // Mouse events
            element.addEventListener('mousedown', dragStart);
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('mousemove', drag);
            
            // Touch events for mobile
            element.addEventListener('touchstart', dragStart);
            document.addEventListener('touchend', dragEnd);
            document.addEventListener('touchmove', drag);
        }

        function openVisionModal() {
            const modalHTML = `
                <h3 class="text-xl font-bold text-center mb-4" style="color: var(--pink-dark);">âœ¨ Ø£Ø¶Ù Ù‡Ø¯ÙÙƒ Ù„Ù€ Vision Board</h3>
                <input type="file" id="vision-image-upload" accept="image/*" class="w-full mb-3 p-2 border border-gray-300 rounded-lg focus:ring-0 focus:border-pink-medium text-sm">
                <input type="text" id="vision-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‡Ø¯Ù (Ù…Ø«Ù„: Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„)" class="w-full mb-3 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-medium">
                <textarea id="vision-description" placeholder="ÙˆØµÙ Ù‚ØµÙŠØ± (Ù…Ø«Ù„Ø§Ù‹: Ø³Ø£Ø³Ø¹Ù‰ Ù„ØªØ­Ù‚ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯Ù Ø¨Ø§Ù„Ø§Ø¬ØªÙ‡Ø§Ø¯ ÙˆØ§Ù„Ù…Ø«Ø§Ø¨Ø±Ø©)" class="w-full mb-4 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-medium resize-none h-20"></textarea>
                <button id="save-vision-item" class="w-full p-3 rounded-xl text-white font-bold transition duration-200 hover:opacity-90 pink-button" style="background-color: var(--pink-accent);">
                    Ø­ÙØ¸ Ø§Ù„Ù‡Ø¯Ù ğŸ€
                </button>
                <button onclick="closeModal()" class="w-full mt-2 p-2 text-sm rounded-xl text-gray-500 hover:text-gray-700 transition duration-200">Ø¥Ù„ØºØ§Ø¡</button>
            `;
            openModal(modalHTML);
            
            document.getElementById('save-vision-item').onclick = () => {
                const fileInput = document.getElementById('vision-image-upload').files[0];
                const title = document.getElementById('vision-title').value;
                const description = document.getElementById('vision-description').value;
                handleAddVisionItem(fileInput, title, description);
            };
        }

        // --- Reminders UI & Modal ---

        function renderReminders(container) {
            requestNotificationPermission(); // Request permission when viewing the page

            const remindersHTML = `
                <h2 class="text-xl font-bold mb-4 text-gray-700 text-center">Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ğŸ””</h2>
                <p class="text-center text-sm text-gray-500 mb-6">Ø§Ø¶ØºØ·ÙŠ Ø¹Ù„Ù‰ Ø²Ø± (+) ÙˆØ§Ø®ØªØ±ØªÙŠ ğŸ”” Ù„Ø¥Ø¶Ø§ÙØ© ØªØ°ÙƒÙŠØ± Ø¬Ø¯ÙŠØ¯.</p>
                <div class="space-y-3">
                    ${reminders.map(r => `
                        <div class="bg-white p-4 rounded-xl shadow-md flex justify-between items-center transition duration-200 hover:shadow-lg" style="border-left: 8px solid var(--pink-medium);">
                            <div class="flex-grow">
                                <p class="text-sm font-semibold text-gray-700">${r.text}</p>
                                <p class="text-xs text-gray-500 mt-1">${r.schedule ? 'Ø³ÙŠØªÙ… Ø§Ù„ØªØ°ÙƒÙŠØ± ÙÙŠ: ' + new Date(r.schedule).toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' }) : 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª'}</p>
                            </div>
                            <button onclick="handleDeleteReminder('${r.id}')" class="text-red-500 hover:text-red-700 ml-3 transition duration-200">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    `).join('')}
                    ${reminders.length === 0 ? '<p class="text-center text-gray-400 p-8">Ù‚Ø§Ø¦Ù…Ø© ØªØ°ÙƒÙŠØ±Ø§ØªÙƒ ÙØ§Ø±ØºØ© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>' : ''}
                </div>
            `;
            container.innerHTML = remindersHTML;
        }

        function openReminderModal() {
             const now = new Date();
             // Adjust time to local timezone for the input default value
             const localISOTime = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            
             const modalHTML = `
                <h3 class="text-xl font-bold text-center mb-4" style="color: var(--pink-dark);">Ø£Ø¶Ù ØªØ°ÙƒÙŠØ± Ø¥ÙŠØ¬Ø§Ø¨ÙŠ ğŸ’–</h3>
                <p class="text-sm text-center text-gray-500 mb-3">ØªØ£ÙƒØ¯ÙŠ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­!</p>
                <textarea id="reminder-text" placeholder="Ø§ÙƒØªØ¨ ØªØ°ÙƒÙŠØ±Ùƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ù‡Ù†Ø§" class="w-full mb-3 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-medium resize-none h-24"></textarea>
                <label for="reminder-time" class="block text-sm font-medium mb-1 text-gray-700">ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø§Ù„ØªØ°ÙƒÙŠØ±:</label>
                <input type="datetime-local" id="reminder-time" min="${localISOTime}" value="${localISOTime}" class="w-full mb-4 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-medium text-sm">
                <button id="save-reminder-item" class="w-full p-3 rounded-xl text-white font-bold transition duration-200 hover:opacity-90 pink-button" style="background-color: var(--pink-accent);">
                    Ø­ÙØ¸ Ø§Ù„ØªØ°ÙƒÙŠØ± ğŸ””
                </button>
                <button onclick="closeModal()" class="w-full mt-2 p-2 text-sm rounded-xl text-gray-500 hover:text-gray-700 transition duration-200">Ø¥Ù„ØºØ§Ø¡</button>
            `;
            openModal(modalHTML);
            
            document.getElementById('save-reminder-item').onclick = () => {
                const text = document.getElementById('reminder-text').value;
                const time = document.getElementById('reminder-time').value;
                handleAddReminder(text, time);
            };
        }

        // --- Journal UI & Modal (Text/Words) ---
        
        function renderJournal(container) {
            const journalHTML = `
                <h2 class="text-xl font-bold mb-4 text-gray-700 text-center">Ø¯ÙØªØ± Ù…Ø°ÙƒØ±Ø§ØªÙŠ ğŸ“”</h2>
                <p class="text-center text-sm text-gray-500 mb-6">Ø§Ø¶ØºØ·ÙŠ Ø¹Ù„Ù‰ Ø²Ø± (+) ÙˆØ§Ø®ØªØ±ØªÙŠ ğŸ“ Ù„ÙƒØªØ§Ø¨Ø© Ù…Ø¯Ø®Ù„ Ø¬Ø¯ÙŠØ¯.</p>

                <div class="space-y-4 mt-6">
                    ${journalEntries.map(entry => `
                        <div class="bg-white p-4 rounded-2xl shadow-lg border-r-8 transition duration-200 hover:shadow-xl" style="border-color: var(--pink-medium);">
                            <p class="text-sm text-gray-800 whitespace-pre-wrap">${entry.content}</p>
                            <p class="text-xs text-gray-400 mt-3 text-left border-t pt-2">${new Date(entry.createdAt).toLocaleString('ar-EG')}</p>
                        </div>
                    `).join('')}
                    ${journalEntries.length === 0 ? '<p class="text-center text-gray-400 p-8">Ø§Ø¨Ø¯Ø¦ÙŠ Ø¨ÙƒØªØ§Ø¨Ø© Ø£ÙˆÙ„ Ù…Ø¯Ø®Ù„ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ù„ÙƒÙ!</p>' : ''}
                </div>
            `;
            
            container.innerHTML = journalHTML;
        }

        function openJournalModal() {
             const modalHTML = `
                <h3 class="text-xl font-bold text-center mb-4" style="color: var(--pink-dark);">ğŸ“ Ù…Ø¯Ø®Ù„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù…Ø°ÙƒØ±Ø§ØªÙŠ</h3>
                <textarea id="journal-input" placeholder="Ø§ÙƒØªØ¨ÙŠ Ù…Ø´Ø§Ø¹Ø±Ùƒ ÙˆØ£ÙÙƒØ§Ø±Ùƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© Ù‡Ù†Ø§..." 
                          class="w-full p-3 h-48 border border-pink-light rounded-2xl resize-none focus:outline-none focus:ring-2 focus:ring-pink-dark text-sm"></textarea>
                <button id="save-journal-btn" class="w-full p-3 mt-4 rounded-xl text-white font-bold transition duration-200 hover:opacity-90 pink-button" style="background-color: var(--pink-accent);">
                    Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø®Ù„ ğŸ’¾
                </button>
                <button onclick="closeModal()" class="w-full mt-2 p-2 text-sm rounded-xl text-gray-500 hover:text-gray-700 transition duration-200">Ø¥Ù„ØºØ§Ø¡</button>
            `;
            
            openModal(modalHTML);
            
            document.getElementById('save-journal-btn').onclick = () => {
                const text = document.getElementById('journal-input').value;
                handleSaveJournalEntry(text);
            };
        }
        
        // --- Anti-Overthinking UI & Logic ---
        
        function getRandomQuote() {
            const randomIndex = Math.floor(Math.random() * mentalHealthQuotes.length);
            return mentalHealthQuotes[randomIndex];
        }
        
        function initializeBreathingSteps() {
            // [instruction, duration_ms, end_size_factor, color]
            // Scale 1.0 = Base size (128px), Scale 1.5 = Expanded size (192px)
            return [
                { text: "Ø´Ù‡ÙŠÙ‚", duration: 4000, startScale: 1.0, endScale: 1.5, color: 'var(--pink-dark)' }, // Inhale
                { text: "Ø­Ø¨Ø³", duration: 4000, startScale: 1.5, endScale: 1.5, color: 'var(--pink-accent)' }, // Hold
                { text: "Ø²ÙÙŠØ±", duration: 6000, startScale: 1.5, endScale: 1.0, color: 'var(--pink-medium)' }, // Exhale
                { text: "Ø§Ø³ØªØ±Ø§Ø­Ø©", duration: 2000, startScale: 1.0, endScale: 1.0, color: 'var(--pink-light)' } // Pause
            ];
        }
        
        function stopBreathingAnimation() {
            if (breathingInterval) {
                clearInterval(breathingInterval);
                breathingInterval = null;
            }
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        function toggleBreathingExercise(forceStop) {
            const button = document.getElementById('toggle-breathing-btn');
            const display = document.getElementById('breathing-display');
            const instruction = document.getElementById('breathing-instruction');

            if (!button || !display || !instruction) return; 
            
            if (isBreathingActive || forceStop) {
                // Stop the exercise
                stopBreathingAnimation();
                isBreathingActive = false;
                button.textContent = 'Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„ØªÙ†ÙØ³ ğŸ§˜â€â™€ï¸';
                button.style.backgroundColor = 'var(--pink-accent)';
                display.style.transform = 'scale(1.0)';
                display.style.boxShadow = '0 0 0 0 rgba(255, 105, 180, 0.4)';
                display.style.backgroundColor = 'var(--pink-medium)';
                instruction.textContent = 'Ø§Ø³ØªØ¹Ø¯ÙŠ Ù„Ù„Ø¨Ø¯Ø¡';
                display.innerHTML = '<span class="text-sm">Ø§Ù†Ù‚Ø± Ù„Ù„Ø¨Ø¯Ø¡</span>';
                display.style.color = 'white';
            } else {
                // Start the exercise
                isBreathingActive = true;
                button.textContent = 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬Ù„Ø³Ø©';
                button.style.backgroundColor = '#EF4444'; // Red for Stop
                breathingSteps = initializeBreathingSteps();
                currentStepIndex = 0;
                startBreathingCycle();
            }
        }
        
        function startBreathingCycle() {
            if (!isBreathingActive) return;

            // Stop any previous cycle intervals
            stopBreathingAnimation();
            
            // Run the first step immediately
            runBreathingStep();
            
            // Set interval to move to the next step (Total cycle duration: 4+4+6+2 = 16 seconds)
            const cycleDuration = breathingSteps.reduce((sum, step) => sum + step.duration, 0);
            
            let accumulatedDelay = 0;
            // First delay is 0, so the first step runs immediately inside runBreathingStep()
            
            breathingSteps.forEach((step, index) => {
                // Set timeout for the start of the next step
                setTimeout(() => {
                    // Only run if the animation is still active (user hasn't stopped it)
                    if (isBreathingActive) {
                         currentStepIndex = index;
                         runBreathingStep();
                    }
                }, accumulatedDelay);
                
                accumulatedDelay += step.duration;
            });
            
            // Re-start the whole cycle when the total cycle duration is met
            breathingInterval = setInterval(() => {
                 if (isBreathingActive) {
                    breathingSteps.forEach((step, index) => {
                        setTimeout(() => {
                             if (isBreathingActive) {
                                currentStepIndex = index;
                                runBreathingStep();
                            }
                        }, breathingSteps.slice(0, index).reduce((sum, s) => sum + s.duration, 0));
                    });
                 } else {
                     clearInterval(breathingInterval);
                 }
            }, cycleDuration);
        }

        function runBreathingStep() {
            const step = breathingSteps[currentStepIndex];
            const display = document.getElementById('breathing-display');
            const instruction = document.getElementById('breathing-instruction');

            if (!display || !instruction || !isBreathingActive) {
                stopBreathingAnimation();
                return;
            }
            
            // 1. Update text instruction
            instruction.textContent = `${step.text} (${Math.floor(step.duration / 1000)} Ø«ÙˆØ§Ù†Ù)`;
            
            // 2. Animate the circle size and color
            // Set transition duration based on the step duration
            display.style.transitionDuration = `${step.duration}ms`; 
            display.style.transform = `scale(${step.endScale})`;
            display.style.backgroundColor = step.color;
            
            // Adjust text color dynamically for better contrast on light/dark backgrounds
            display.style.color = (step.color === 'var(--pink-light)') ? 'var(--text-color)' : 'white'; 
            
            // 3. Update inner countdown
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            let countdown = Math.floor(step.duration / 1000);
            // Display the starting countdown value
            display.innerHTML = countdown;
            
            // Inner countdown interval
            countdownInterval = setInterval(() => {
                countdown--;
                if (countdown >= 0) {
                    display.innerHTML = countdown;
                } else {
                    clearInterval(countdownInterval);
                    // The main cycle timer will call the next step
                }
            }, 1000);

            // Add pulsing glow effect
            const glowFactor = step.endScale === 1.5 ? 30 : 0; 
            display.style.boxShadow = `0 0 ${glowFactor}px ${step.color} inset, 0 0 ${glowFactor}px ${step.color}`;
        }
        
        /**
         * Opens the special "Rescue Message" modal.
         */
        function openRescueMessage() {
             const rescueHTML = `
                <h3 class="text-2xl font-bold text-center mb-4" style="color: var(--pink-accent);">ğŸ’Œ Ø±Ø³Ø§Ù„Ø© Ø¥Ù†Ù‚Ø§Ø° Ø³Ø±ÙŠØ¹Ø©</h3>
                
                <div class="bg-pink-light p-4 rounded-xl shadow-inner mb-4">
                    <p class="text-lg font-extrabold text-gray-800 mb-3 text-center">
                        ğŸ›‘ "Ù…Ù‡Ù„Ø§Ù‹... Ø§Ù„Ø£ÙÙƒØ§Ø± Ø§Ù„Ø³Ù„Ø¨ÙŠØ© Ù„ÙŠØ³Øª Ø­Ù‚Ø§Ø¦Ù‚!"
                    </p>
                    <p class="text-md text-gray-700 text-center leading-relaxed">
                        Ø¹Ù‚Ù„Ùƒ ÙŠØ¨Ø§Ù„Øº ÙÙŠ Ø§Ù„ØªØ®ÙŠÙ„ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ù‡Ø§Ù‚. Ù„Ø§ Ø¨Ø£Ø³ØŒ Ù‡Ø°Ø§ Ù„ÙŠØ³ ÙˆØ§Ù‚Ø¹Ùƒ.
                    </p>
                    <p class="text-md text-gray-700 font-bold mt-3 text-center leading-relaxed">
                        Ø§Ø°Ù‡Ø¨ÙŠ Ø¥Ù„Ù‰ ØµÙØ­Ø© **Ù…Ø°ÙƒØ±Ø§ØªÙŠ**ØŒ Ø§Ø³ØªØ¹Ø±Ø¶ÙŠ Ù„Ø­Ø¸Ø© ÙˆØ§Ø­Ø¯Ø© Ø¬ÙŠØ¯Ø© Ø¯ÙˆÙ†ØªÙÙ‡Ø§ØŒ ÙˆØªØ°ÙƒØ±ÙŠ:
                        <br><span style="color: var(--pink-dark); font-weight: 800;">Ø£Ù†ØªÙ Ø¨Ø®ÙŠØ±ØŒ ÙˆÙ‡Ø°Ø§ Ø³ÙŠÙ…Ø¶ÙŠ.</span>
                    </p>
                </div>
                
                <button onclick="closeModal()" class="w-full p-3 mt-4 rounded-xl text-white font-bold transition duration-200 hover:opacity-90 pink-button" style="background-color: var(--pink-dark);">
                    Ø­Ø³Ù†Ø§Ù‹ØŒ Ø³Ø£ØªÙ†ÙØ³ Ø§Ù„Ø¢Ù† ğŸ’–
                </button>
            `;
            openModal(rescueHTML);
        }


        function renderAntiOverthinking(container) {
            const quote = getRandomQuote();
            
            const antiHTML = `
                <h2 class="text-xl font-bold mb-6 text-gray-700 text-center">Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù‡Ø¯ÙˆØ¡ ÙˆØ§Ù„ØªØ£Ø±ÙŠØ¶ ğŸ§˜â€â™€ï¸</h2>
                
                <!-- 1. Quote/Affirmation Card -->
                <div class="bg-white p-6 rounded-3xl shadow-xl mb-6 border-l-8" style="border-color: var(--pink-accent);">
                    <p class="text-lg font-extrabold italic text-gray-800 mb-3 text-center" style="font-family: 'Cairo', sans-serif;">
                        "${quote.quote}"
                    </p>
                    <p class="text-xs text-gray-500 text-left">- ${quote.source}</p>
                </div>
                
                <!-- 0. Rescue Message Button -->
                <button onclick="openRescueMessage()" class="w-full p-3 rounded-xl text-white font-bold mb-8 transition duration-200 hover:scale-[1.01] hover:opacity-90 pink-button" 
                        style="background-color: var(--pink-accent);">
                    Ø£ÙÙƒØ§Ø± Ø³Ù„Ø¨ÙŠØ© ØªÙ‡Ø§Ø¬Ù…Ù†ÙŠ! (Ø±Ø³Ø§Ù„Ø© Ø¥Ù†Ù‚Ø§Ø°) ğŸ†˜
                </button>


                <!-- 2. Breathing Exercise -->
                <div class="bg-white p-6 rounded-3xl shadow-xl mb-8">
                    <h3 class="text-lg font-bold mb-4 text-center" style="color: var(--pink-dark);">ØªÙ…Ø±ÙŠÙ† Ø§Ù„ØªÙ†ÙØ³ Ø§Ù„Ù…Ù‡Ø¯Ø¦</h3>
                    <div id="breathing-display" class="relative mx-auto w-32 h-32 rounded-full flex items-center justify-center text-white font-extrabold text-2xl cursor-pointer" 
                         style="background-color: var(--pink-medium); box-shadow: 0 0 0 0 rgba(255, 105, 180, 0.4);"
                         onclick="if(!isBreathingActive) toggleBreathingExercise();">
                        <span class="text-sm">${isBreathingActive ? '' : 'Ø§Ù†Ù‚Ø± Ù„Ù„Ø¨Ø¯Ø¡'}</span>
                    </div>
                    <p id="breathing-instruction" class="text-center mt-4 text-gray-700 font-semibold">Ø§Ø³ØªØ¹Ø¯ÙŠ Ù„Ù„Ø¨Ø¯Ø¡</p>
                    <p class="text-center text-sm text-gray-500 mt-2">Ø¯ÙˆØ±Ø© ÙˆØ§Ø­Ø¯Ø©: Ø´Ù‡ÙŠÙ‚ (4Ø«)ØŒ Ø­Ø¨Ø³ (4Ø«)ØŒ Ø²ÙÙŠØ± (6Ø«)ØŒ Ø§Ø³ØªØ±Ø§Ø­Ø© (2Ø«)</p>
                    <button id="toggle-breathing-btn" class="w-full mt-4 p-3 rounded-xl text-white font-bold transition duration-200 hover:opacity-90 pink-button" 
                            style="background-color: ${isBreathingActive ? '#EF4444' : 'var(--pink-accent)'};">
                        ${isBreathingActive ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬Ù„Ø³Ø©' : 'Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„ØªÙ†ÙØ³ ğŸ§˜â€â™€ï¸'}
                    </button>
                </div>

                <!-- 3. Grounding Exercise (5-4-3-2-1) -->
                <div class="bg-white p-6 rounded-3xl shadow-xl">
                    <h3 class="text-lg font-bold mb-4 text-center" style="color: var(--pink-dark);">ØªÙ…Ø±ÙŠÙ† Ø§Ù„ØªØ£Ø±ÙŠØ¶ (5-4-3-2-1)</h3>
                    <p class="text-sm text-gray-600 mb-4 text-center">Ù„ØªØ´ØªÙŠØª Ø§Ù„Ù‚Ù„Ù‚ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ±ÙƒÙŠØ²Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ù„Ø­Ø¸Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</p>
                    <ul class="space-y-3">
                        <li class="grounding-list-item">
                            <span class="text-2xl ml-2 text-pink-700">5ï¸âƒ£</span>
                            <div>
                                <span class="font-bold text-gray-700">Ø£Ø´ÙŠØ§Ø¡ ØªØ±ÙŠÙ†Ù‡Ø§:</span>
                                <span class="text-sm text-gray-500"> Ø§Ù†Ø¸Ø±ÙŠ Ø­ÙˆÙ„Ùƒ ÙˆØ³Ù…Ù‘ÙŠ 5 Ø£Ø´ÙŠØ§Ø¡ (Ø§Ù„Ù„ÙˆÙ†ØŒ Ø§Ù„Ø´ÙƒÙ„ØŒ Ø§Ù„Ù…Ù„Ù…Ø³).</span>
                            </div>
                        </li>
                         <li class="grounding-list-item">
                            <span class="text-2xl ml-2 text-pink-700">4ï¸âƒ£</span>
                            <div>
                                <span class="font-bold text-gray-700">Ø£Ø´ÙŠØ§Ø¡ ØªØ´Ø¹Ø±ÙŠÙ† Ø¨Ù‡Ø§:</span>
                                <span class="text-sm text-gray-500"> Ù…Ø³Ù‘ÙŠ 4 Ø£Ø´ÙŠØ§Ø¡ (Ù…Ù„Ø§Ø¨Ø³ÙƒØŒ Ø§Ù„ÙƒØ±Ø³ÙŠØŒ Ù‡Ø§ØªÙÙƒ).</span>
                            </div>
                        </li>
                        <li class="grounding-list-item">
                            <span class="text-2xl ml-2 text-pink-700">3ï¸âƒ£</span>
                            <div>
                                <span class="font-bold text-gray-700">Ø£Ø´ÙŠØ§Ø¡ ØªØ³Ù…Ø¹ÙŠÙ†Ù‡Ø§:</span>
                                <span class="text-sm text-gray-500"> Ø£ØµØºÙŠ Ø¬ÙŠØ¯Ø§Ù‹ ÙˆØ³Ù…Ù‘ÙŠ 3 Ø£ØµÙˆØ§Øª Ø­ÙˆÙ„Ùƒ (Ø¨Ø¹ÙŠØ¯Ø© Ø£Ùˆ Ù‚Ø±ÙŠØ¨Ø©).</span>
                            </div>
                        </li>
                        <li class="grounding-list-item">
                            <span class="text-2xl ml-2 text-pink-700">2ï¸âƒ£</span>
                            <div>
                                <span class="font-bold text-gray-700">Ø£Ø´ÙŠØ§Ø¡ ØªØ´Ù…ÙŠÙ†Ù‡Ø§:</span>
                                <span class="text-sm text-gray-500"> Ø³Ù…Ù‘ÙŠ Ø±Ø§Ø¦Ø­ØªÙŠÙ† (Ù‚Ù‡ÙˆØ©ØŒ Ø¹Ø·Ø±ØŒ Ù‡ÙˆØ§Ø¡ Ø§Ù„ØºØ±ÙØ©).</span>
                            </div>
                        </li>
                        <li class="grounding-list-item">
                            <span class="text-2xl ml-2 text-pink-700">1ï¸âƒ£</span>
                            <div>
                                <span class="font-bold text-gray-700">Ø´ÙŠØ¡ ØªØªØ°ÙˆÙ‚ÙŠÙ†Ù‡/ØªØ¤ÙƒØ¯ÙŠÙ†Ù‡:</span>
                                <span class="text-sm text-gray-500"> ØªÙ†Ø§ÙˆÙ„ÙŠ Ø´ÙŠØ¦Ø§Ù‹ Ø£Ùˆ Ù‚ÙˆÙ„ÙŠ ØªØ£ÙƒÙŠØ¯Ø§Ù‹ Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ§Ù‹ Ø¨ØµÙˆØª Ø¹Ø§Ù„Ù.</span>
                            </div>
                        </li>
                    </ul>
                </div>
            `;
            container.innerHTML = antiHTML;
            
            // Attach event listener for breathing exercise
            const breathingBtn = document.getElementById('toggle-breathing-btn');
            if(breathingBtn) breathingBtn.onclick = () => toggleBreathingExercise(false); // No force stop
            
            // Re-apply state if active
            if (isBreathingActive) {
                // This re-establishes the state if the user navigates away and comes back
                // We call runBreathingStep() to update the display to the current phase text and countdown
                breathingSteps = initializeBreathingSteps();
                runBreathingStep(); 
            }
        }


        // --- Event Listeners and Initializers ---

        document.addEventListener('DOMContentLoaded', () => {
            // Setup navigation listeners
            document.querySelectorAll('.tab-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    const page = e.currentTarget.dataset.page;
                    renderPage(page);
                });
            });

            // Setup FAB listener to toggle Quick Action Menu
            document.getElementById('fab-button').addEventListener('click', () => {
                toggleActionMenu();
            });
            
            // Setup Quick Action Menu buttons to open specific modals
            document.getElementById('action-add-image').onclick = openVisionModal;
            document.getElementById('action-add-text').onclick = openJournalModal;
            document.getElementById('action-add-reminder').onclick = openReminderModal;


            // Start Firebase and render default page
            initFirebase();
            renderPage(currentPage); // Initial render
        });

    </script>
</body>
</html>

i